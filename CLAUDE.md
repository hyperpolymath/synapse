# CLAUDE.md - AI Assistant Context for Synapse

> This file provides context for AI assistants (Claude, etc.) working with the Synapse codebase.

## Project Overview

**Synapse** is a Zig-based meta-compiler that generates SwiftUI ViewModels from Rust struct definitions. It bridges the Rust↔Swift divide, eliminating boilerplate while maintaining type safety and Apple platform compliance.

### Core Philosophy

1. **Single Source of Truth**: Rust structs define the "World" - Swift is just the interface
2. **Template-Based Generation**: When Apple changes requirements, update templates once
3. **Zero Runtime**: Build-time only, no runtime overhead
4. **RSR Gold Compliant**: Full Rhodium Standard Repository compliance

## Architecture

```
synapse/
├── src/
│   ├── generators/synapse.zig    # Main CLI entry point
│   ├── parser/rust_parser.zig    # Rust struct parser
│   └── templates/swift_templates.zig  # SwiftUI code generation
├── examples/
│   ├── rust/models.rs            # Example input structs
│   └── swift/Generated.swift     # Generated output (gitignored)
├── .well-known/                  # RFC compliance files
└── build.zig                     # Zig build configuration
```

### Data Flow

```
Rust Source (#[derive(Synapse)])
       ↓
   rust_parser.zig (parse structs, fields, types)
       ↓
   swift_templates.zig (apply iOS-version templates)
       ↓
Swift ViewModel Output (@Observable or @ObservableObject)
```

## Key Files

| File | Purpose | When to Modify |
|------|---------|----------------|
| `src/generators/synapse.zig` | CLI, orchestration | Adding CLI flags, new workflows |
| `src/parser/rust_parser.zig` | Rust parsing | Supporting new Rust syntax |
| `src/templates/swift_templates.zig` | Swift generation | Apple API changes, new iOS versions |
| `build.zig` | Build configuration | Adding modules, changing targets |
| `Justfile` | Developer commands | Adding workflows, RSR validation |

## Development Commands

```bash
# Build
zig build                    # Build Synapse binary

# Generate
just gen-ui                  # Generate Swift from default examples
just gen-ui input=X output=Y # Custom input/output paths
just gen-ui-legacy           # iOS 14-16 compatible output

# Test
zig build test               # Run all unit tests

# Validate
just validate                # Full RSR Gold compliance check
just check-spdx              # Verify SPDX headers

# Clean
just clean                   # Remove build artifacts
```

## Code Conventions

### Zig Style

- **SPDX Headers**: Every `.zig` file starts with:
  ```zig
  // SPDX-License-Identifier: MIT
  // SPDX-FileCopyrightText: 2024 Synapse Contributors
  ```
- **Formatting**: Run `zig fmt src/` before committing
- **Error Handling**: Use `try` for propagation, explicit handling for user-facing errors
- **Memory**: Use allocators explicitly, prefer arena allocation for parsing

### Rust Input Conventions

Structs marked for generation use these derives:
- `#[derive(Synapse)]` - Primary marker
- `#[derive(DriftUI)]` - Alias for Drift project
- `#[derive(SwiftBridge)]` - Alias for clarity

### Generated Swift Conventions

- iOS 17+: Uses `@Observable` macro
- iOS 14-16: Uses `ObservableObject` protocol with `@Published`
- Always `@MainActor` for UI thread safety
- Generated files marked: `// AUTO-GENERATED BY SYNAPSE - DO NOT EDIT`

## Type Mapping

| Rust | Swift | Notes |
|------|-------|-------|
| `i32` | `Int` | Platform-native |
| `i64` | `Int64` | Explicit 64-bit |
| `f32` | `Float` | |
| `f64` | `Double` | |
| `bool` | `Bool` | |
| `String` | `String` | |
| `Vec<T>` | `[T]` | TODO: Generic extraction |
| `Option<T>` | `T?` | TODO: Generic extraction |
| Custom | Pass-through | UniFFI handles bridging |

## Common Tasks

### Adding a New Rust Type

1. Edit `src/parser/rust_parser.zig`:
   - Add to `RustType` enum
   - Update `parseRustType()` function
   - Add `toSwiftType()` mapping

2. Edit `src/templates/swift_templates.zig`:
   - Update `mapRustTypeToSwift()`
   - Update `getDefaultValue()`

3. Add test case in parser tests

### Supporting a New iOS Version

1. Edit `src/templates/swift_templates.zig`:
   - Add version check in `generateViewModel()`
   - Create new template function if needed
   - Update header comments

2. Update `Justfile` with new command if needed

3. Update `CHANGELOG.md`

### Adding CLI Flags

1. Edit `src/generators/synapse.zig`:
   - Add field to `SynapseConfig`
   - Parse in `main()` argument loop
   - Update `printHelp()`

## Testing

### Unit Tests

Each module has embedded tests:

```bash
zig build test  # Runs all tests
```

### Manual Testing

```bash
just gen-ui
cat examples/swift/Generated.swift
```

### Test Coverage Goals

- Parser: All Rust primitive types, struct variations, derive combinations
- Templates: iOS 17+ and legacy output, all type mappings
- CLI: All flags, error cases

## Important Constraints

1. **No Network Access**: Synapse is offline-only by design
2. **No Runtime Dependencies**: Generated code has no Synapse dependencies
3. **Deterministic Output**: Same input always produces same output
4. **Backward Compatible**: Generated code works with UniFFI bindings

## RSR Gold Compliance

This project maintains RSR Gold compliance. Key requirements:

- All source files have SPDX headers
- Documentation in root: README, LICENSE, SECURITY, etc.
- `.well-known/` directory with RFC-compliant files
- `just validate` passes all checks

When modifying, ensure:
- New source files get SPDX headers
- CHANGELOG.md updated for user-facing changes
- No regression in `just validate`

## Debugging Tips

### Parser Issues

```zig
// Add debug output in parseRustStructs():
std.debug.print("Parsing line: {s}\n", .{line});
```

### Template Issues

Generate to stdout for inspection:
```bash
zig build run -- --input examples/rust/models.rs --output /dev/stdout
```

### Build Issues

```bash
zig build --verbose
```

## Integration Points

### UniFFI

Synapse complements UniFFI:
- UniFFI: Rust FFI → Swift types
- Synapse: Rust structs → SwiftUI ViewModels

Use both:
```rust
#[derive(uniffi::Object, Synapse)]
pub struct Player { ... }
```

### Xcode

Generated files go in your iOS project:
```bash
just deploy-ios ~/MyApp/MyApp/Generated
```

## Contact

- Issues: GitLab issue tracker
- Security: See SECURITY.md
- Governance: See GOVERNANCE.adoc
